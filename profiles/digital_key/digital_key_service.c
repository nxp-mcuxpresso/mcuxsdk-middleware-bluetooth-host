/*! *********************************************************************************
 * \addtogroup Digital Key Profile
 * @{
 ********************************************************************************** */
/*! *********************************************************************************
* \file digital_key_service.c
*
* Copyright 2020-2022 NXP
*
* NXP Confidential Proprietary
*
* No part of this document must be reproduced in any form - including copied,
* transcribed, printed or by any electronic means - without specific written
* permission from NXP.
********************************************************************************** */

/************************************************************************************
*************************************************************************************
* Include
*************************************************************************************
************************************************************************************/
#include "FunctionLib.h"
#include "ble_general.h"
#include "gatt_db_app_interface.h"
#include "gatt_server_interface.h"
#include "gap_interface.h"
#include "l2ca_cb_interface.h"
#include "digital_key_interface.h"
#include "fsl_component_mem_manager.h"

/************************************************************************************
*************************************************************************************
* Private constants & macros
*************************************************************************************
************************************************************************************/

/************************************************************************************
*************************************************************************************
* Private type definitions
*************************************************************************************
************************************************************************************/

/************************************************************************************
*************************************************************************************
* Private memory declarations
*************************************************************************************
************************************************************************************/

/************************************************************************************
*************************************************************************************
* Private functions prototypes
*************************************************************************************
************************************************************************************/

/************************************************************************************
*************************************************************************************
* Public memory declarations
*************************************************************************************
************************************************************************************/

/************************************************************************************
*************************************************************************************
* Public functions
*************************************************************************************
************************************************************************************/

/*!**********************************************************************************
* \brief        Sends a Digital Key Service message on L2CAP channel.
*
* \param[in]    deviceId          Peer device ID.
* \param[in]    channelId         L2CAP channel ID.
* \param[in]    messageType       Message type.
* \param[in]    msgId             RS message ID (payload type).
* \param[in]    length            Payload length.
* \param[in]    pData             Pointer to buffer containing payload.
*
* \return       gBleSuccess_c or error.
************************************************************************************/
bleResult_t DK_SendMessage(deviceId_t deviceId, uint16_t channelId, dkMessageType_t messageType,
                           rangingMsgId_t msgId, uint16_t length, uint8_t *pData)
{
    bleResult_t result = gBleSuccess_c;

    uint16_t l2caBufLen = gMessageHeaderSize_c + gPayloadHeaderSize_c + gLengthFieldSize_c + length;
    uint8_t* l2caBuf = MEM_BufferAlloc(l2caBufLen);

    if (NULL != l2caBuf)
    {
        l2caBuf[0] = (uint8_t)messageType;
        l2caBuf[1] = (uint8_t)msgId;
        Utils_BePackTwoByteValue(length, l2caBuf + gMessageHeaderSize_c + gPayloadHeaderSize_c);
        FLib_MemCpy((void*)(l2caBuf + gMessageHeaderSize_c + gPayloadHeaderSize_c + gLengthFieldSize_c), pData, length);
    }
    else
    {
        result = gBleOutOfMemory_c;
    }

    if (result == gBleSuccess_c)
    {
        result = L2ca_SendLeCbData(deviceId, channelId, l2caBuf, l2caBufLen);
    }

    if (NULL != l2caBuf)
    {
        (void)MEM_BufferFree(l2caBuf);
    }
    return result;
}
/************************************************************************************
*************************************************************************************
* Private functions
*************************************************************************************
************************************************************************************/

/*! *********************************************************************************
 * @}
 ********************************************************************************** */
